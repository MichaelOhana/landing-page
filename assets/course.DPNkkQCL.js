(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();function E(e){let t=e.length,o;for(;t!==0;)o=Math.floor(Math.random()*t),t--,[e[t],e[o]]=[e[o],e[t]];return e}function b(e){if(!e)return"";if(e.length===11&&/^[a-zA-Z0-9_-]+$/.test(e))return e;const t=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,o=e.match(t);return o&&o[2].length===11?o[2]:e}function x(e,t=10,o=null){if(!e)return"";const i=`<span class="inline-block border-b-2 border-gray-400 mx-1" style="min-width: ${Math.max(50,t*8)}px;"></span>`;let r=e.replace(/___BLANK___/g,i);if(o&&r===e){const n=new RegExp(`\\b${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"gi");r=r.replace(n,i)}return r}function C(e,t){console.log("[renderYouTubeClips] Called with:",{clips:e,containerId:t});const o=document.getElementById(t);if(!o){console.error("[renderYouTubeClips] Container not found:",t),console.error("[renderYouTubeClips] Available elements with ID:",Array.from(document.querySelectorAll("[id]")).map(r=>r.id));return}if(console.log("[renderYouTubeClips] Container found:",o),!e||e.length===0){console.log("[renderYouTubeClips] No clips provided, showing empty state"),o.innerHTML=`
            <div class="text-gray-500 italic p-6 bg-gray-50 rounded-lg text-center">
                No YouTube clips available for this word.
            </div>
        `;return}console.log("[renderYouTubeClips] Rendering",e.length,"clips:",e);const i=`
        <div class="space-y-4">
            <h3 class="text-2xl font-semibold text-purple-700 mb-4 border-b-2 border-purple-200 pb-2">YouTube Clips</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${e.map((r,n)=>{const s=b(r.youtube_url);return console.log("[renderYouTubeClips] Processing clip",n,":",{original_url:r.youtube_url,extracted_id:s,start_sec:r.start_sec}),s?`
                        <div class="relative rounded-lg overflow-hidden shadow-md bg-black" style="padding-bottom: 56.25%;">
                            <iframe class="absolute top-0 left-0 w-full h-full"
                                src="https://www.youtube.com/embed/${s}?start=${r.start_sec||0}&playsinline=1&iv_load_policy=3&rel=0&showinfo=0&modestbranding=1&controls=1&fs=0&autoplay=0&disablekb=1&enablejsapi=1&origin=${encodeURIComponent(window.location.origin)}&widgetid=1&forigin=${encodeURIComponent(window.location.origin)}&aoriginsup=1&gporigin=${encodeURIComponent(window.location.origin)}&vf=6"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                            </iframe>
                        </div>
                    `:(console.warn("[renderYouTubeClips] Invalid video ID for clip:",r),`
                        <div class="relative rounded-lg overflow-hidden shadow-md bg-red-100 p-4">
                            <p class="text-red-600">Invalid YouTube URL: ${r.youtube_url}</p>
                        </div>
                    `)}).join("")}
            </div>
        </div>
    `;console.log("[renderYouTubeClips] Setting container HTML"),o.innerHTML=i,console.log("[renderYouTubeClips] Clips rendered successfully")}const _=Object.freeze(Object.defineProperty({__proto__:null,formatSentenceWithBlank:x,getYouTubeVideoId:b,renderYouTubeClips:C,shuffleArray:E},Symbol.toStringTag,{value:"Module"})),p="Spanish",g=5,w="100_EN_real_estate.sqlite3",W="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/",h={MENU:"views/menu.html",WORD_DETAIL:"views/word-detail.html",PRACTICE:"views/practice.html"};async function M(){try{console.log("Loading SQL.js WASM...");const e=await window.initSqlJs({locateFile:i=>`${W}${i}`});console.log("Fetching database file:",w);const t=await fetch(w);if(!t.ok)throw new Error(`Failed to fetch database: ${t.statusText}`);const o=await t.arrayBuffer();console.log("Creating database instance..."),this.db=new e.Database(new Uint8Array(o)),console.log("Database loaded successfully.")}catch(e){throw console.error("Database initialization error:",e),this.error=(this.error?this.error+"; ":"")+(e.message||"An unknown error occurred during DB initialization."),e}}function S(e,t=[]){if(!this.db)return console.error("Database not initialized."),this.error="Database not initialized. Cannot execute query.",null;try{const o=this.db.prepare(e);o.bind(t);const i=[];for(;o.step();)i.push(o.getAsObject());return o.free(),i}catch(o){return console.error("Error executing query:",e,o),this.error=`Query failed: ${o.message}`,null}}function T(){try{const t=this.executeQuery("SELECT name FROM sqlite_master WHERE type='table'")||[];console.log("[databaseService] Available tables:",t.map(r=>r.name));const o=t.some(r=>r.name.toLowerCase()==="modules");console.log("[databaseService] Has modules table:",o);const i=t.some(r=>r.name.toLowerCase()==="clips");return console.log("[databaseService] Has clips table:",i),this.logTableStructures(t,i),{tables:t,hasModulesTable:o,hasClipsTable:i}}catch(e){return console.error("[databaseService] Error checking database schema:",e),{tables:[],hasModulesTable:!1,hasClipsTable:!1}}}function L(e,t){var o;if(e.some(i=>i.name.toLowerCase()==="words")){const i=this.executeQuery("PRAGMA table_info(words)")||[];console.log("[databaseService] Words table structure:",i)}if(t){const i=this.executeQuery("PRAGMA table_info(clips)")||[];console.log("[databaseService] Clips table structure:",i);const r=this.executeQuery("SELECT COUNT(*) as count FROM clips")||[];console.log("[databaseService] Total clips in database:",((o=r[0])==null?void 0:o.count)||0),this.logSampleClipsData(r)}}function P(e){var t;if(((t=e[0])==null?void 0:t.count)>0){const o=this.executeQuery("SELECT * FROM clips LIMIT 3")||[];console.log("[databaseService] Sample clips:",o);const i=this.executeQuery(`
            SELECT w.id, w.term, COUNT(c.id) as clip_count 
            FROM words w 
            LEFT JOIN clips c ON w.id = c.word_id 
            WHERE c.id IS NOT NULL 
            GROUP BY w.id, w.term 
            ORDER BY clip_count DESC 
            LIMIT 5
        `)||[];console.log("[databaseService] Words with clips:",i)}}const O=Object.freeze(Object.defineProperty({__proto__:null,checkDatabaseSchema:T,executeQuery:S,initDB:M,logSampleClipsData:P,logTableStructures:L},Symbol.toStringTag,{value:"Module"}));async function R(){this.isLoadingHtmlViews=!0,console.log("[view.js] Loading HTML views...");try{const[e,t,o]=await Promise.all([fetch(h.WORD_DETAIL),fetch(h.PRACTICE),fetch(h.PAYMENT_POPUP)]);if(!e.ok)throw new Error(`Failed to fetch ${h.WORD_DETAIL}: ${e.statusText}`);if(this.wordDetailViewHtml=await e.text(),!t.ok)throw new Error(`Failed to fetch ${h.PRACTICE}: ${t.statusText}`);if(this.practiceViewHtml=await t.text(),!o.ok)throw new Error(`Failed to fetch ${h.PAYMENT_POPUP}: ${o.statusText}`);this.paymentPopupHtml=await o.text(),console.log("[view.js] HTML views loaded successfully.")}catch(e){console.error("[view.js] Error loading HTML views:",e),this.error=(this.error?this.error+"; ":"")+`Failed to load page templates: ${e.message}`,this.wordDetailViewHtml||(this.wordDetailViewHtml='<p class="text-red-500 text-center">Error loading word detail view. Please refresh.</p>'),this.practiceViewHtml||(this.practiceViewHtml='<p class="text-red-500 text-center">Error loading practice view. Please refresh.</p>'),this.paymentPopupHtml||(this.paymentPopupHtml='<p class="text-red-500 text-center">Error loading payment popup. Please refresh.</p>')}finally{this.isLoadingHtmlViews=!1}}async function N(){console.log("[view.js] showMenuView()"),this.currentView="menu";const e=document.getElementById("view-container");e&&(e.innerHTML=`
            <div class="pt-16 md:pt-0">
                <div class="text-center py-20">
                    <h1 class="text-3xl font-bold text-purple-700 mb-4">Curso de Aprendizaje de Idiomas</h1>
                    <p class="text-lg text-gray-600 mb-6">Selecciona un m√≥dulo del panel de navegaci√≥n para comenzar a aprender.</p>
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h2 class="text-xl font-semibold text-purple-600 mb-4">C√≥mo Usar Este Curso</h2>
                        <div class="text-left space-y-3 text-gray-700">
                            <p>‚Ä¢ <strong>Explorar M√≥dulos:</strong> Haz clic en cualquier m√≥dulo en el panel izquierdo para expandir y ver sus palabras</p>
                            <p>‚Ä¢ <strong>Estudiar Palabras:</strong> Haz clic en palabras individuales para ver informaci√≥n detallada, ejemplos y audio</p>
                            <p>‚Ä¢ <strong>Sesiones de Pr√°ctica:</strong> Cada m√≥dulo tiene opciones de pr√°ctica estrat√©gicamente ubicadas:</p>
                            <p class="ml-6">üìù <strong>Practicar Primeras 5 Palabras</strong> - Aparece despu√©s de la 5¬™ palabra</p>
                            <p class="ml-6">üéØ <strong>Practicar Palabras Restantes</strong> - Aparece al final para las palabras 6+</p>
                            <p class="ml-6">üìö <strong>Practicar Todas las Palabras</strong> - Revisi√≥n completa del m√≥dulo al final</p>
                            <p>‚Ä¢ <strong>Tipos de Ejercicios:</strong> La pr√°ctica incluye completar oraciones y conversaciones</p>
                        </div>
                    </div>
                </div>
            </div>
        `)}async function I(e){console.log("[view.js] showWordDetail()",e),this.currentView="word",this.selectedWordId=e,this.wordDetailsCache&&this.wordDetailsCache.has(e)||(this.isLoadingWordDetails=!0);const o=document.getElementById("view-container");o&&this.wordDetailViewHtml&&(o.innerHTML=this.wordDetailViewHtml,await new Promise(i=>setTimeout(i,150))),await this.loadWordDetailsById(e),this.initializeYouGlishWidgetWithRetry(),this.currentWord&&this.currentWord.clips?(console.log("[view.js] Rendering clips. Clips found:",this.currentWord.clips.length),await this.renderYouTubeClipsWithRetry()):this.currentWord&&(console.log("[view.js] Word loaded but no clips available for word:",this.currentWord.term),this.showNoClipsMessage()),this.isLoadingWordDetails=!1}async function A(){let e=0;const t=4,o=50,i=async()=>{if(e++,document.getElementById("youglish-container"))return this.initializeYouGlishWidget(),!0;if(e<t)return await new Promise(n=>setTimeout(n,o)),i.call(this);{console.error("[view.js] YouGlish container not found. Creating fallback.");const n=document.querySelector('[x-show="currentWord && !isLoadingWordDetails"]');if(n){const s=document.createElement("div");return s.id="youglish-container",n.appendChild(s),this.initializeYouGlishWidget(),!0}return!1}};return await i.call(this)}async function j(){let e=0;const t=4,o=50,i=async()=>(e++,document.getElementById("youtube-clips-container")?(console.log("[view.js] Container found on attempt",e,", rendering clips..."),this.renderYouTubeClips(this.currentWord.clips,"youtube-clips-container"),!0):e<t?(console.log("[view.js] Container not found, attempt",e,"of",t,", retrying in",o,"ms..."),await new Promise(n=>setTimeout(n,o)),i()):(console.error("[view.js] youtube-clips-container not found after",t,"attempts"),this.createFallbackClipsContainer()));return await i()}function D(){const e=document.querySelector('[x-show="currentWord && !isLoadingWordDetails"]');if(e){console.log("[view.js] Found word detail container, creating fallback clips container");const t=document.createElement("div");return t.id="youtube-clips-container",t.className="space-y-4 mt-6",e.appendChild(t),console.log("[view.js] Created fallback container, rendering clips..."),this.renderYouTubeClips(this.currentWord.clips,"youtube-clips-container"),!0}else return console.error("[view.js] Could not find any suitable container for clips"),!1}function H(){const e=document.getElementById("youtube-clips-container");e&&(e.innerHTML=`
            <div class="text-gray-500 italic p-6 bg-gray-50 rounded-lg text-center">
                No YouTube clips available for this word.
            </div>
        `)}function F(){console.log("[view.js] goBackToWordList()"),this.currentView="menu",this.selectedWordId=null,this.currentWord=null,this.showMenuView()}const B=Object.freeze(Object.defineProperty({__proto__:null,createFallbackClipsContainer:D,goBackToWordList:F,initializeYouGlishWidgetWithRetry:A,loadHtmlViews:R,renderYouTubeClipsWithRetry:j,showMenuView:N,showNoClipsMessage:H,showWordDetail:I},Symbol.toStringTag,{value:"Module"}));function k(e){if(!this.selectedModuleId||!e)return;this.viewedWordsInModule.add(e),console.log(`Viewed words in module ${this.selectedModuleId}:`,Array.from(this.viewedWordsInModule));const t=this.wordsInSelectedModule.length;if(t!==0)if(this.viewedWordsInModule.size>=g&&!this.midModulePracticeCompleted&&t>g){console.log("Triggering mid-module practice."),this.midModulePracticeCompleted=!0;const o=Array.from(this.viewedWordsInModule).slice(0,g);this.startPracticeSession(o,`Pr√°ctica: Primeras ${g} Palabras`)}else this.viewedWordsInModule.size===t&&!this.endModulePracticeCompleted&&(console.log("Triggering end-of-module practice."),this.endModulePracticeCompleted=!0,this.startPracticeSession(Array.from(this.viewedWordsInModule),"Pr√°ctica: Todas las Palabras del M√≥dulo"))}async function $(e,t){if(!e||e.length===0){console.warn("No words provided for practice session."),this.currentView="menu";return}this.closeMobileMenu(),this.isPracticeActive=!0,this.isLoadingPractice=!0,this.currentView="practice",this.practiceSessionTitle=t,this.practiceExercises=[],this.currentExerciseIndex=-1,this.currentExercise=null,this.userAnswer=null,this.feedbackMessage={type:"",text:""},this.practiceCompletionMessage="";const o=document.getElementById("view-container");o&&this.practiceViewHtml&&(o.innerHTML=this.practiceViewHtml,await new Promise(a=>setTimeout(a,150))),console.log("Starting practice session for word IDs:",e);const i=`
        SELECT feb.id, feb.word_id, feb.sentence AS questionText, feb.distractor_words_json, w.term AS correctAnswerTerm
        FROM fill_in_blank_exercises feb
        JOIN words w ON feb.word_id = w.id
        WHERE feb.word_id IN (${e.map(()=>"?").join(",")});
    `,r=`
        SELECT fce.id, fce.word_id, fce.conversation_json AS questionTextJson, fce.distractor_words_json, w.term AS correctAnswerTerm
        FROM fill_in_conversation_exercises fce
        JOIN words w ON fce.word_id = w.id
        WHERE fce.word_id IN (${e.map(()=>"?").join(",")});
    `,n=this.executeQuery(i,e)||[],s=this.executeQuery(r,e)||[];n.forEach(a=>{let l=[];try{l=JSON.parse(a.distractor_words_json||"[]")}catch(c){console.error("Error parsing distractor_words_json for blank ex:",c,a.distractor_words_json)}this.practiceExercises.push({...a,type:"fill-blank",options:this.shuffleArray([a.correctAnswerTerm,...l])})}),s.forEach(a=>{let l=[],c=[];try{l=JSON.parse(a.distractor_words_json||"[]")}catch(u){console.error("Error parsing distractor_words_json for convo ex:",u,a.distractor_words_json)}try{c=JSON.parse(a.questionTextJson||"[]"),c=c.map(u=>({speaker:u.speaker||"Speaker",line:u.line||u.text||"Missing text"}))}catch(u){console.error("Error parsing conversation_json:",u,a.questionTextJson),c=[{speaker:"Error",line:"No se pudo cargar la conversaci√≥n."}]}this.practiceExercises.push({...a,questionText:c,type:"fill-conversation",options:this.shuffleArray([a.correctAnswerTerm,...l])})}),this.shuffleArray(this.practiceExercises),console.log("Prepared practice exercises:",this.practiceExercises),this.practiceExercises.length>0?(this.currentExerciseIndex=0,this.displayCurrentExercise()):(this.practiceCompletionMessage="No se encontraron ejercicios de pr√°ctica para este conjunto de palabras.",this.currentExercise=null),this.isLoadingPractice=!1}function Q(){this.userAnswer=null,this.feedbackMessage={type:"",text:""},this.currentExerciseIndex>=0&&this.currentExerciseIndex<this.practiceExercises.length?(this.currentExercise=this.practiceExercises[this.currentExerciseIndex],console.log("Displaying exercise:",this.currentExerciseIndex+1,this.currentExercise)):(this.currentExercise=null,this.practiceCompletionMessage=this.practiceExercises.length>0?"¬°Sesi√≥n de pr√°ctica completada! Bien hecho.":"No hab√≠a ejercicios disponibles para esta sesi√≥n.",console.log("Practice session ended or no exercises."))}function Y(e){this.feedbackMessage.text===""&&(this.userAnswer=e)}function V(){!this.userAnswer||!this.currentExercise||(this.userAnswer===this.currentExercise.correctAnswerTerm?this.feedbackMessage={type:"success",text:"¬°Bien hecho!"}:this.feedbackMessage={type:"error",text:`La respuesta correcta era ${this.currentExercise.correctAnswerTerm}`})}function z(){this.currentExerciseIndex<this.practiceExercises.length-1?(this.currentExerciseIndex++,this.displayCurrentExercise()):this.displayCurrentExercise()}function q(){this.isPracticeActive=!1,this.currentView="menu"}function G(e){if(!Array.isArray(e)||e.length===0)return;console.log("[practiceService] initiatePractice()",e.length,"words");const t=e.map(o=>o.id).filter(o=>o);if(t.length===0){console.warn("[practiceService] No valid word IDs found for practice");return}this.startPracticeSession(t,`Practice: All ${t.length} Words`)}const U=Object.freeze(Object.defineProperty({__proto__:null,displayCurrentExercise:Q,finishPracticeSession:q,initiatePractice:G,nextExercise:z,selectAnswer:Y,startPracticeSession:$,submitAnswer:V,trackViewedWord:k},Symbol.toStringTag,{value:"Module"}));function J(){if((!this.modules||this.modules.length===0)&&this.allWordsFlat.length>0){console.log("[navigationService] Extracting modules from words data...");const e=new Map;this.allWordsFlat.forEach(t=>{t.module_id&&!e.has(t.module_id)&&e.set(t.module_id,{id:t.module_id,name:t.module_name||`M√≥dulo ${t.module_id}`,description:t.module_description||"M√≥dulo que contiene palabras"})}),this.modules=Array.from(e.values()),console.log("[navigationService] Extracted modules:",this.modules)}}function K(){console.log("[navigationService] Total modules available:",this.modules.length),this.modules&&this.modules.length>0?this.populateModulesOnly():this.populateWordNavigation()}function Z(){this.modules&&this.modules.length>0&&(console.log("[navigationService] Fallback: showing modules without words"),this.populateModulesOnly())}function X(){const e=document.getElementById("word-navigation-list");if(!e){console.error("[navigationService] Navigation list element not found");return}console.log("[navigationService] Populating navigation with modules only"),this.clearNavigationList(e),[...this.modules].sort((o,i)=>o.id-i.id).forEach(o=>{this.createModuleNavigationItem(o,e)}),console.log("[navigationService] Navigation populated with modules only")}function ee(){const e=document.getElementById("word-navigation-list");if(!e){console.error("[navigationService] Navigation list element not found");return}if(!this.allWordsFlat||this.allWordsFlat.length===0){console.warn("[navigationService] No words available for navigation");return}console.log("[navigationService] Populating fallback word navigation with",this.allWordsFlat.length,"words"),e.innerHTML='<div class="p-4 text-gray-500">Cargando navegaci√≥n de palabras...</div>'}function te(e){const t=e.querySelector('[x-show="isLoading"]');e.innerHTML="",t&&e.appendChild(t)}function oe(e,t){const o=this.createModuleHeader(e),i=this.createWordsContainer(e.id);this.addModuleClickHandler(o,i,e),t.appendChild(o),t.appendChild(i)}function re(e){const t=document.createElement("li");return t.className="font-semibold text-purple-700 mt-4 mb-2 border border-purple-200 rounded-lg p-3 cursor-pointer hover:bg-purple-50 transition-colors",t.innerHTML=`
        <div class="flex justify-between items-center">
            <div class="flex-1">
                <div class="text-sm font-bold flex items-center gap-2">
                    ${e.name}
                </div>
                ${e.description?`<div class="text-xs text-purple-600 font-normal mt-1">${e.description}</div>`:""}
            </div>
            <span class="module-toggle text-purple-500">‚ñº</span>
        </div>
    `,t}function ie(e){const t=document.createElement("ul");return t.className="module-words hidden mt-2 ml-4 space-y-1",t.setAttribute("data-module-id",e),t}function ne(e,t,o){e.addEventListener("click",async()=>{const i=e.querySelector(".module-toggle");!t.classList.contains("hidden")?(t.classList.add("hidden"),i.textContent="‚ñº"):(t.children.length===0&&await this.loadWordsForModuleNavigation(o.id,t),t.classList.remove("hidden"),i.textContent="‚ñ≤",this.selectModule(o.id))})}async function se(e){console.log("[navigationService] selectWordFromNav()",e),this.selectedWordId=e,this.closeMobileMenu(),await this.showWordDetail(e)}const ae=Object.freeze(Object.defineProperty({__proto__:null,addModuleClickHandler:ne,clearNavigationList:te,createModuleHeader:re,createModuleNavigationItem:oe,createWordsContainer:ie,extractModulesFromWordsIfNeeded:J,fallbackToModulesOnly:Z,populateModulesOnly:X,populateNavigation:K,populateWordNavigation:ee,selectWordFromNav:se},Symbol.toStringTag,{value:"Module"}));function le(){this.isMobileMenuOpen=!this.isMobileMenuOpen,this.isMobileMenuOpen?document.body.classList.add("overflow-hidden"):document.body.classList.remove("overflow-hidden")}function ce(){this.isMobileMenuOpen&&(this.isMobileMenuOpen=!1,document.body.classList.remove("overflow-hidden"))}function de(){const e=window.innerWidth>=768;this.isMobileMenuOpen=e,document.body.classList.remove("overflow-hidden")}function ue(){const e=document.getElementById("payment-popup");e&&(e.style.display="flex")}function pe(){const e=document.getElementById("payment-popup");e&&(e.style.display="none")}function he(){if(this.paymentPopupHtml){const e=document.createElement("div");e.innerHTML=this.paymentPopupHtml,document.body.appendChild(e.firstElementChild)}}function me(e){if(e)try{let t;if(e instanceof Blob)t=e;else if(e instanceof ArrayBuffer||e instanceof Uint8Array)t=new Blob([e],{type:"audio/mpeg"});else return;const o=URL.createObjectURL(t);this.audioPlayer&&(this.audioPlayer.src=o,this.audioPlayer.play().catch(i=>console.error("Error playing audio:",i)))}catch(t){console.error("Error processing audio data:",t)}}const ge=Object.freeze(Object.defineProperty({__proto__:null,closeMobileMenu:ce,closePaymentPopup:pe,initializeMobileMenuState:de,playAudio:me,setupPaymentPopup:he,showPaymentPopup:ue,toggleMobileMenu:le},Symbol.toStringTag,{value:"Module"}));async function fe(e){if(!e){this.error="No word ID provided.";return}try{if(this.wordDetailsCache&&this.wordDetailsCache.has(e)){console.log("[contentService] Loading word details from cache for:",e),this.loadWordFromCache(e);return}console.log("[contentService] Word not in cache, loading from database:",e),await this.loadWordFromDatabase(e)}catch(t){console.error("[contentService] loadWordDetailsById() error:",t),this.error="Error al cargar los detalles de la palabra",this.currentWord=null}}function we(e){this.currentWord=this.getWordDetails(e),this.selectedWordDetails={id:this.currentWord.id,term:this.currentWord.term,definition:this.currentWord.definition,translation:this.currentWord.translation,pronunciation:this.currentWord.pronunciation,audio_data:this.currentWord.audioSrc,notes:this.currentWord.notes},this.selectedWordExamples=this.currentWord.exampleSentences.map(t=>({text:t.english,audio_data:t.audioSrc})),this.selectedWordConversations=[],this.currentWord.conversation.forEach(t=>{this.selectedWordConversations.push(...t.lines.map(o=>({speaker_label:o.speaker,text:o.line,audio_data:o.audioSrc,line_order:o.lineOrder,id:o.dbId})))}),this.selectedWordClips=this.currentWord.clips,console.log("[contentService] Word details loaded from cache:",this.currentWord)}async function be(){try{(!this.modules||this.modules.length===0)&&(console.log("[contentService] Loading modules first..."),this.loadModules());const e=`
            SELECT w.*, m.id as module_id, m.name as module_name, m.description as module_description
            FROM words w
            JOIN word_module_assignments wma ON w.id = wma.word_id
            JOIN modules m ON wma.module_id = m.id
            ORDER BY m.name, w.term
        `;this.allWordsFlat=this.executeQuery(e)??[],console.log("[contentService] Loaded words with modules:",this.allWordsFlat.length),await this.preloadCache(),this.extractModulesFromWordsIfNeeded(),this.populateNavigation()}catch(e){console.error("[contentService] loadAllWordsForNavigation() error:",e),this.error="Error al cargar las palabras para la navegaci√≥n",this.fallbackToModulesOnly()}}function ve(){if(!this.db){this.error="Database not available to load modules.",console.error(this.error);return}const t=this.executeQuery("SELECT id, name, description FROM modules ORDER BY name;");t?(this.modules=t,console.log("[contentService] Modules loaded:",this.modules)):console.error("[contentService] Failed to load modules.")}function ye(e){console.log(`[contentService] Module selected: ${e}`),this.selectedModuleId=e,this.selectedWordId=null,this.wordsInSelectedModule=[],this.clearWordDetails(),this.viewedWordsInModule.clear(),this.midModulePracticeCompleted=!1,this.endModulePracticeCompleted=!1,this.isPracticeActive=!1,e&&this.loadWordsForModule(e)}function Ee(e){if(!this.db){this.error="Database not available to load words.",console.error(this.error);return}const o=this.executeQuery(`
        SELECT w.id, w.term
        FROM words w
        JOIN word_module_assignments wma ON w.id = wma.word_id
        WHERE wma.module_id = ?
        ORDER BY w.term;
    `,[e]);o?(this.wordsInSelectedModule=o,console.log(`[contentService] Words for module ${e}:`,this.wordsInSelectedModule),this.wordsInSelectedModule.length===0&&console.warn(`[contentService] No words found for module ${e}.`)):console.error(`[contentService] Failed to load words for module ${e}.`)}function xe(e){return!0}function Ce(){this.selectedWordDetails={term:null,definition:null,audio_data:null,translation:null},this.selectedWordExamples=[],this.selectedWordConversations=[],this.selectedWordClips=[],this.currentWord=null}const _e=Object.freeze(Object.defineProperty({__proto__:null,clearWordDetails:Ce,isModuleFree:xe,loadAllWordsForNavigation:be,loadModules:ve,loadWordDetailsById:fe,loadWordFromCache:we,loadWordsForModule:Ee,selectModule:ye},Symbol.toStringTag,{value:"Module"}));async function We(){console.log("[cacheService] Preloading complete word details for all words..."),this.wordDetailsCache=new Map;const e=this.allWordsFlat.map(l=>l.id);if(e.length===0)return;const t=e.map(()=>"?").join(","),o=this.loadTranslationsBatch(e,t),i=this.loadExamplesBatch(e,t),r=this.loadConversationsBatch(e,t),n=this.loadClipsBatch(e,t),s=this.loadExampleTranslationsBatch(i),a=this.loadConversationTranslationsBatch(r);this.buildWordDetailsCache(o,i,r,n,s,a),console.log("[cacheService] Preloaded complete details for",this.wordDetailsCache.size,"words")}function Me(e,t){const o=`SELECT words_id, translation FROM words_translations WHERE words_id IN (${t}) AND language_code = ?`,i=this.executeQuery(o,[...e,p])||[];return new Map(i.map(r=>[r.words_id,r.translation]))}function Se(e,t){const o=`SELECT * FROM examples WHERE word_id IN (${t})`;return(this.executeQuery(o,e)||[]).reduce((r,n)=>(r[n.word_id]||(r[n.word_id]=[]),r[n.word_id].push(n),r),{})}function Te(e,t){const o=`SELECT * FROM conversation_lines WHERE word_id IN (${t}) ORDER BY id`;return(this.executeQuery(o,e)||[]).reduce((r,n)=>(r[n.word_id]||(r[n.word_id]=[]),r[n.word_id].push(n),r),{})}function Le(e,t){const o=`SELECT * FROM clips WHERE word_id IN (${t})`;return(this.executeQuery(o,e)||[]).reduce((r,n)=>(r[n.word_id]||(r[n.word_id]=[]),r[n.word_id].push(n),r),{})}function Pe(e){const t=Object.values(e).flat();if(t.length===0)return new Map;const o=t.map(s=>s.id),r=`SELECT example_id, translation FROM example_translations WHERE example_id IN (${o.map(()=>"?").join(",")}) AND language_code = ?`,n=this.executeQuery(r,[...o,p])||[];return new Map(n.map(s=>[s.example_id,s.translation]))}function Oe(e){const t=Object.values(e).flat();if(t.length===0)return new Map;const o=t.map(s=>s.id),r=`SELECT conversation_line_id, translation FROM conversation_line_translations WHERE conversation_line_id IN (${o.map(()=>"?").join(",")}) AND language_code = ?`,n=this.executeQuery(r,[...o,p])||[];return new Map(n.map(s=>[s.conversation_line_id,s.translation]))}function Re(e,t,o,i,r,n){this.allWordsFlat.forEach(s=>{const a=s.id,l=t[a]||[],c=o[a]||[],u=i[a]||[],m=l.map(d=>({english:d.text,translation:r.get(d.id),audioSrc:d.audio_data})),v=c.map(d=>({speaker:d.speaker_label||"Speaker",line:d.text,translatedLine:n.get(d.id),audioSrc:d.audio_data,lineOrder:d.line_order,dbId:d.id})),y=this.groupConversationLinesForCache(v);this.wordDetailsCache.set(a,{id:s.id,term:s.term,definition:s.definition,translation:e.get(a)||s.translation,pronunciation:s.pronunciation,audioSrc:s.audio_data,exampleSentences:m,conversation:y.map(d=>({lines:d})),clips:u,notes:s.notes})})}function Ne(e){const t=[];let o=[],i=-1;return e.forEach(r=>{(r.lineOrder===0||r.lineOrder<i)&&o.length>0&&(t.push([...o]),o=[]),o.push(r),i=r.lineOrder}),o.length>0&&t.push(o),t.forEach(r=>{r.sort((n,s)=>(n.lineOrder||0)-(s.lineOrder||0))}),t}function Ie(e){return this.wordDetailsCache.get(e)}const Ae=Object.freeze(Object.defineProperty({__proto__:null,buildWordDetailsCache:Re,getWordDetails:Ie,groupConversationLinesForCache:Ne,loadClipsBatch:Le,loadConversationTranslationsBatch:Oe,loadConversationsBatch:Te,loadExampleTranslationsBatch:Pe,loadExamplesBatch:Se,loadTranslationsBatch:Me,preloadCache:We},Symbol.toStringTag,{value:"Module"}));async function je(e){if(!this.db){this.error="Database not available.";return}const o=this.executeQuery("SELECT * FROM words WHERE id = ?",[e]);if(o&&o.length>0){const i=o[0],r=await this.loadWordTranslation(e);this.currentWord={id:i.id,term:i.term,definition:i.definition,translation:r||i.translation,pronunciation:i.pronunciation,audioSrc:i.audio_data,exampleSentences:[],conversation:[],clips:[],notes:i.notes},this.selectedWordDetails={...i,translation:r||i.translation},await this.loadWordExamples(e),await this.loadWordConversations(e),await this.loadWordClips(e),console.log("[wordLoaderService] Word details loaded for:",e,this.currentWord)}else this.error=`Palabra con ID ${e} no encontrada.`,this.currentWord=null}async function De(e){try{const o=this.executeQuery("SELECT translation FROM words_translations WHERE words_id = ? AND language_code = ?",[e,p]);return o&&o.length>0?o[0].translation:null}catch(t){return console.warn("[wordLoaderService] Word translations table not available or error loading translation:",t),null}}async function He(e){try{const o=this.executeQuery("SELECT * FROM examples WHERE word_id = ?",[e])||[];this.selectedWordExamples=o,this.currentWord.exampleSentences=await Promise.all(o.map(async i=>{const r=await this.loadExampleTranslation(i.id);return{english:i.text,translation:r,audioSrc:i.audio_data}}))}catch(t){console.warn("[wordLoaderService] Examples table not available or error loading examples:",t),this.selectedWordExamples=[],this.currentWord.exampleSentences=[]}}async function Fe(e){try{const o=this.executeQuery("SELECT translation FROM example_translations WHERE example_id = ? AND language_code = ?",[e,p]);return o&&o.length>0?o[0].translation:null}catch(t){return console.warn("[wordLoaderService] Example translations table not available:",t),null}}async function Be(e){try{const o=this.executeQuery("SELECT * FROM conversation_lines WHERE word_id = ? ORDER BY id",[e])||[];if(this.selectedWordConversations=o,o.length>0){const i=await this.processConversationLines(o),r=this.groupConversationLines(i);this.currentWord.conversation=r.map(n=>({lines:n}))}}catch(t){console.warn("[wordLoaderService] Conversations table not available or error loading conversations:",t),this.selectedWordConversations=[],this.currentWord.conversation=[]}}async function ke(e){return await Promise.all(e.map(async t=>{const o=await this.loadConversationTranslation(t.id);return{speaker:t.speaker_label||"Speaker",line:t.text,translatedLine:o,audioSrc:t.audio_data,lineOrder:t.line_order,dbId:t.id}}))}async function $e(e){try{const o=this.executeQuery("SELECT translation FROM conversation_line_translations WHERE conversation_line_id = ? AND language_code = ?",[e,p]);return o&&o.length>0?o[0].translation:null}catch(t){return console.warn("[wordLoaderService] Conversation translations table not available:",t),null}}function Qe(e){const t=[];let o=[],i=-1;return e.forEach(r=>{(r.lineOrder===0||r.lineOrder<i)&&o.length>0&&(t.push([...o]),o=[]),o.push(r),i=r.lineOrder}),o.length>0&&t.push(o),t.forEach(r=>{r.sort((n,s)=>(n.lineOrder||0)-(s.lineOrder||0))}),t}async function Ye(e){try{const o=this.executeQuery("SELECT * FROM clips WHERE word_id = ?",[e])||[];this.selectedWordClips=o,this.currentWord.clips=o}catch(t){console.warn("[wordLoaderService] Clips table not available or error loading clips:",t),this.selectedWordClips=[],this.currentWord.clips=[]}}const Ve=Object.freeze(Object.defineProperty({__proto__:null,groupConversationLines:Qe,loadConversationTranslation:$e,loadExampleTranslation:Fe,loadWordClips:Ye,loadWordConversations:Be,loadWordExamples:He,loadWordFromDatabase:je,loadWordTranslation:De,processConversationLines:ke},Symbol.toStringTag,{value:"Module"}));function ze(){return{db:null,isLoading:!0,isLoadingHtmlViews:!0,error:null,currentView:"menu",isMobileMenuOpen:!1,menuViewHtml:'<p class="text-center text-gray-500">Loading menu view...</p>',wordDetailViewHtml:'<p class="text-center text-gray-500">Loading word detail view...</p>',practiceViewHtml:'<p class="text-center text-gray-500">Loading practice view...</p>',modules:[],allWordsFlat:[],selectedModuleId:null,wordsInSelectedModule:[],selectedWordId:null,targetLanguageCode:p,currentWord:null,wordDetailsCache:new Map,isLoadingWordDetails:!1,selectedWordDetails:{term:null,definition:null,audio_data:null,translation:null},selectedWordExamples:[],selectedWordConversations:[],selectedWordClips:[],audioPlayer:new Audio,viewedWordsInModule:new Set,midModulePracticeCompleted:!1,endModulePracticeCompleted:!1,isPracticeActive:!1,isLoadingPractice:!1,practiceSessionTitle:"",practiceExercises:[],currentExerciseIndex:-1,currentExercise:null,userAnswer:null,feedbackMessage:{type:"",text:""},practiceCompletionMessage:""}}console.log("[main.js] Script start");function qe(){return{...ze(),..._,...O,...B,...U,...ae,...ge,..._e,...Ae,...Ve,async init(){console.log("[main.js] init()"),window.appStateInstance=this,this.initializeMobileMenuState();try{console.log("[main.js] Step 1: Initializing database..."),await this.initDB(),console.log("[main.js] Database initialized successfully"),console.log("[main.js] Step 2: Loading HTML views..."),await this.loadHtmlViews(),console.log("[main.js] HTML views loaded successfully"),this.setupPaymentPopup(),console.log("[main.js] Step 3: Checking database schema...");const t=this.checkDatabaseSchema();console.log("[main.js] Step 4: Loading modules..."),t.hasModulesTable?this.loadModules():(console.log("[main.js] No modules table found, will extract from words"),this.modules=[]),console.log("[main.js] Step 5: Loading words for navigation..."),await this.loadAllWordsForNavigation(),console.log("[main.js] Step 6: Showing menu view..."),await this.showMenuView(),this.isLoading=!1,console.log("[main.js] Initialization complete!")}catch(t){console.error("[main.js] initialisation failed:",t),this.error=t.message,this.isLoading=!1}},initializeYouGlishWidget(){if(!this.currentWord||!this.currentWord.term)return;const t=document.getElementById("youglish-container");if(!t)return;t.innerHTML="";const o=`yg-widget-${this.currentWord.id||Date.now()}`,i=document.createElement("div");i.id=o,t.appendChild(i);const r=this.currentWord.term.split("(")[0].trim();if(typeof window.YG<"u"&&window.YG.Widget)try{new window.YG.Widget(o,{components:8415,"bkg-color":"theme_light",query:r,lang:"english"})}catch(n){console.error("[main.js] Error creating YouGlish widget:",n),t.innerHTML="<p>Could not load pronunciation widget.</p>"}else window.youglishWidgetConfig={term:r,widgetId:o}},async loadWordsForModuleNavigation(t,o){try{const r=this.executeQuery(`
                    SELECT w.id, w.term FROM words w
                    JOIN word_module_assignments wma ON w.id = wma.word_id
                    WHERE wma.module_id = ? ORDER BY w.term
                `,[t])||[];o.innerHTML="",r.forEach((n,s)=>{const a=document.createElement("div");a.className="cursor-pointer p-2 rounded hover:bg-purple-100 transition-colors text-sm border-l-2 border-purple-200 pl-3",a.textContent=n.term||"Palabra desconocida",a.addEventListener("click",l=>{if(l.stopPropagation(),!this.isModuleFree(t)){this.showPaymentPopup();return}this.selectWordFromNav(n.id)}),o.appendChild(a),s===4&&r.length>5&&this.addPracticeSection(o,r.slice(0,5),"Practicar Primeras 5 Palabras",t)}),this.addEndPracticeSections(o,r,t)}catch(i){console.error(`[main.js] Error loading words for module ${t}:`,i),o.innerHTML='<div class="text-red-500 text-xs p-2">Error al cargar las palabras</div>'}},addPracticeSection(t,o,i,r){const n=document.createElement("div");n.className="my-3 p-3 bg-blue-50 rounded-lg border border-blue-200";const s=document.createElement("button");s.className="w-full text-left px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300 font-medium",s.textContent=`üìù ${i}`,s.addEventListener("click",a=>{a.stopPropagation();const l=o.map(m=>m.id),c=this.modules.find(m=>m.id==r),u=c?c.name:`M√≥dulo ${r}`;this.startPracticeSession(l,`Pr√°ctica: ${i} - ${u}`)}),n.appendChild(s),t.appendChild(n)},addEndPracticeSections(t,o,i){const r=document.createElement("div");r.className="mt-3 space-y-2 border-t border-gray-200 pt-3";const n=this.modules.find(a=>a.id==i),s=n?n.name:`M√≥dulo ${i}`;o.length>5&&this.addRemainingWordsPractice(r,o,s),this.addAllWordsPractice(r,o,s),t.appendChild(r)},addRemainingWordsPractice(t,o,i){const r=document.createElement("div");r.className="p-2 bg-gray-50 rounded border border-gray-200";const n=document.createElement("button");n.className="w-full text-left px-2 py-1 text-xs text-orange-600 rounded hover:bg-orange-50 transition-colors border-0 font-normal";const s=o.length-5;n.textContent=`üéØ Practicar ${s} Palabras Restantes`,n.addEventListener("click",a=>{a.stopPropagation();const l=o.slice(5).map(c=>c.id);this.startPracticeSession(l,`Pr√°ctica: ${s} Palabras Restantes - ${i}`)}),r.appendChild(n),t.appendChild(r)},addAllWordsPractice(t,o,i){const r=document.createElement("div");r.className="p-2 bg-gray-50 rounded border border-gray-200";const n=document.createElement("button");n.className="w-full text-left px-2 py-1 text-xs text-green-600 rounded hover:bg-green-50 transition-colors border-0 font-normal",n.textContent=`üìö Practicar Todas las ${o.length} Palabras`,n.addEventListener("click",s=>{s.stopPropagation();const a=o.map(l=>l.id);this.startPracticeSession(a,`Pr√°ctica: Todas las Palabras - ${i}`)}),r.appendChild(n),t.appendChild(r)}}}function f(){return typeof Alpine<"u"?(Alpine.data("appState",qe),!0):!1}if(!f()){document.addEventListener("alpine:init",f);let e=0;const t=setInterval(()=>{e++,(f()||e>50)&&clearInterval(t)},100)}window.onYouglishAPIReady=function(e){if(window.youglishWidgetConfig){const{term:t,widgetId:o}=window.youglishWidgetConfig,i=document.getElementById("youglish-container");if(i){if(!document.getElementById(o)){i.innerHTML="";const r=document.createElement("div");r.id=o,i.appendChild(r)}try{new e.Widget(o,{components:8415,"bkg-color":"theme_light",query:t,lang:"english"})}catch(r){console.error("[main.js] Error creating delayed YouGlish widget:",r),i.innerHTML="<p>Could not load pronunciation widget.</p>"}}window.youglishWidgetConfig=null}};console.log("[main.js] Script end");
